<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Admin Dashboard - Vidyasshree Shikshana Kendra</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(-45deg, #ff8c42, #ff6b1a, #ff9f68, #ff7530);
      background-size: 400% 400%;
      animation: gradientBG 12s ease infinite;
      min-height: 100vh;
      padding: 2rem 0;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      animation: fadeIn 1s ease;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .logout-btn {
      position: absolute;
      top: 2rem;
      right: 2rem;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid rgba(255,255,255,0.3);
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-2px);
    }

    .section {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      opacity: 0;
      transform: translateY(30px);
      animation: slideUp 0.8s ease forwards;
    }

    .section:nth-child(2) { animation-delay: 0.2s; }
    .section:nth-child(3) { animation-delay: 0.4s; }

    @keyframes slideUp {
      to { opacity: 1; transform: translateY(0); }
    }

    .section-title {
      color: #ff6b1a;
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title::before {
      content: "üëë";
      font-size: 1.5rem;
    }

    .pending-requests .section-title::before { content: "‚è≥"; }
    .approved-teachers .section-title::before { content: "‚úÖ"; }

    .request-card, .teacher-card {
      background: #fff;
      border: 2px solid #e1e8ed;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .request-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #ff8c42, #ff6b1a);
      transition: left 0.3s ease;
    }

    .request-card:hover::before {
      left: 0;
    }

    .request-card:hover, .teacher-card:hover {
      border-color: #ff8c42;
      box-shadow: 0 10px 30px rgba(255,140,66,0.2);
      transform: translateY(-2px);
    }

    .request-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-size: 0.8rem;
      color: #666;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .info-value {
      font-size: 1rem;
      color: #333;
      font-weight: 500;
    }

    .request-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .action-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .approve-btn {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
    }

    .approve-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(46,204,113,0.4);
    }

    .reject-btn {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    .reject-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(231,76,60,0.4);
    }

    .status-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-approved {
      background: rgba(46,204,113,0.1);
      color: #27ae60;
      border: 2px solid rgba(46,204,113,0.3);
    }

    .status-pending {
      background: rgba(243,156,18,0.1);
      color: #f39c12;
      border: 2px solid rgba(243,156,18,0.3);
    }

    .status-rejected {
      background: rgba(231,76,60,0.1);
      color: #c0392b;
      border: 2px solid rgba(231,76,60,0.3);
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #666;
    }

    .empty-state h3 {
      margin-bottom: 1rem;
      color: #999;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(255,140,66,0.1), rgba(255,107,26,0.1));
      border: 2px solid rgba(255,140,66,0.3);
      border-radius: 15px;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(255,140,66,0.2);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: #ff6b1a;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: #666;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.9rem;
    }

    .message {
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .message.success {
      background: rgba(46,204,113,0.1);
      color: #27ae60;
      border: 2px solid rgba(46,204,113,0.3);
    }

    .message.error {
      background: rgba(231,76,60,0.1);
      color: #c0392b;
      border: 2px solid rgba(231,76,60,0.3);
    }

    @media (max-width: 768px) {
      .dashboard-container {
        padding: 0 0.5rem;
      }
      
      .section {
        padding: 1rem;
      }
      
      .request-info {
        grid-template-columns: 1fr;
      }
      
      .request-actions {
        flex-direction: column;
      }
      
      .logout-btn {
        position: relative;
        top: auto;
        right: auto;
        margin: 0 auto 2rem auto;
        display: block;
      }
    }
  </style>
</head>
<body>
  <button class="logout-btn" onclick="logout()">Logout</button>

  <div class="header">
    <h1>Super Admin Dashboard</h1>
    <p>Manage Teacher Account Approvals</p>
  </div>

  <div class="dashboard-container">
    <!-- Statistics -->
    <div class="section">
      <h2 class="section-title">Dashboard Overview</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="pendingCount">0</div>
          <div class="stat-label">Pending Requests</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="approvedCount">0</div>
          <div class="stat-label">Approved Teachers</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="rejectedCount">0</div>
          <div class="stat-label">Rejected Requests</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalCount">0</div>
          <div class="stat-label">Total Requests</div>
        </div>
      </div>
    </div>

    <!-- Pending Requests -->
    <div class="section pending-requests">
      <h2 class="section-title">Pending Teacher Requests</h2>
      <div id="message-container"></div>
      <div id="pending-requests-container">
        <div class="loading">Loading pending requests...</div>
      </div>
    </div>

    <!-- Approved Teachers -->
    <div class="section approved-teachers">
      <h2 class="section-title">Approved Teachers</h2>
      <div id="approved-teachers-container">
        <div class="loading">Loading approved teachers...</div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, updateDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAp5yz00tXRKLhBIQoYq4sKIiFrjHzUsmY",
      authDomain: "vidhyashree-mlr.firebaseapp.com",
      projectId: "vidhyashree-mlr",
      storageBucket: "vidhyashree-mlr.firebasestorage.app",
      messagingSenderId: "469584837803",
      appId: "1:469584837803:web:b1a9355fb0661c32ba8bee",
      measurementId: "G-LYEYRP433X"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let pendingRequests = [];
    let approvedTeachers = [];
    let rejectedRequests = [];

    // Load data on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadAllData();
    });

    async function loadAllData() {
      try {
        await Promise.all([
          loadPendingRequests(),
          loadApprovedTeachers(),
          loadRejectedRequests()
        ]);
        updateStatistics();
      } catch (error) {
        showMessage('Error loading data: ' + error.message, 'error');
      }
    }

    async function loadPendingRequests() {
      try {
        // Try with orderBy first
        let q = query(
          collection(db, 'admin-requests'),
          where('status', '==', 'pending')
        );
        
        try {
          q = query(q, orderBy('requestedAt', 'desc'));
        } catch (indexError) {
          console.log('Using query without orderBy due to index issue');
        }
        
        const snapshot = await getDocs(q);
        pendingRequests = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Sort manually if needed
        pendingRequests.sort((a, b) => {
          const dateA = new Date(a.requestedAt || 0);
          const dateB = new Date(b.requestedAt || 0);
          return dateB - dateA;
        });
        
        renderPendingRequests();
      } catch (error) {
        console.error('Error loading pending requests:', error);
        // Try simpler query without any filters
        try {
          const allSnapshot = await getDocs(collection(db, 'admin-requests'));
          pendingRequests = allSnapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(doc => doc.status === 'pending');
          renderPendingRequests();
        } catch (fallbackError) {
          document.getElementById('pending-requests-container').innerHTML = 
            '<div class="empty-state"><h3>Error loading pending requests</h3><p>Please check Firebase configuration</p></div>';
        }
      }
    }

    async function loadApprovedTeachers() {
      try {
        // Try with orderBy first
        let q = query(
          collection(db, 'admin-requests'),
          where('status', '==', 'approved')
        );
        
        try {
          q = query(q, orderBy('requestedAt', 'desc'));
        } catch (indexError) {
          console.log('Using query without orderBy due to index issue');
        }
        
        const snapshot = await getDocs(q);
        approvedTeachers = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Sort manually if needed
        approvedTeachers.sort((a, b) => {
          const dateA = new Date(a.requestedAt || 0);
          const dateB = new Date(b.requestedAt || 0);
          return dateB - dateA;
        });
        
        renderApprovedTeachers();
      } catch (error) {
        console.error('Error loading approved teachers:', error);
        // Try simpler query without any filters
        try {
          const allSnapshot = await getDocs(collection(db, 'admin-requests'));
          approvedTeachers = allSnapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(doc => doc.status === 'approved');
          renderApprovedTeachers();
        } catch (fallbackError) {
          document.getElementById('approved-teachers-container').innerHTML = 
            '<div class="empty-state"><h3>Error loading approved teachers</h3><p>Please check Firebase configuration</p></div>';
        }
      }
    }

    async function loadRejectedRequests() {
      try {
        // Try with orderBy first
        let q = query(
          collection(db, 'admin-requests'),
          where('status', '==', 'rejected')
        );
        
        try {
          q = query(q, orderBy('requestedAt', 'desc'));
        } catch (indexError) {
          console.log('Using query without orderBy due to index issue');
        }
        
        const snapshot = await getDocs(q);
        rejectedRequests = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Sort manually if needed
        rejectedRequests.sort((a, b) => {
          const dateA = new Date(a.requestedAt || 0);
          const dateB = new Date(b.requestedAt || 0);
          return dateB - dateA;
        });
      } catch (error) {
        console.error('Error loading rejected requests:', error);
        // Try simpler query without any filters
        try {
          const allSnapshot = await getDocs(collection(db, 'admin-requests'));
          rejectedRequests = allSnapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(doc => doc.status === 'rejected');
        } catch (fallbackError) {
          console.error('Fallback query also failed:', fallbackError);
        }
      }
    }

    function renderPendingRequests() {
      const container = document.getElementById('pending-requests-container');
      
      if (pendingRequests.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>üéâ No Pending Requests</h3>
            <p>All teacher requests have been processed!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = pendingRequests.map(request => `
        <div class="request-card">
          <div class="status-badge status-pending">Pending</div>
          <div class="request-info">
            <div class="info-item">
              <div class="info-label">Full Name</div>
              <div class="info-value">${request.name}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Email</div>
              <div class="info-value">${request.email}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Phone</div>
              <div class="info-value">${request.phone}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Subject/Department</div>
              <div class="info-value">${request.subject}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Qualification</div>
              <div class="info-value">${request.qualification}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Request Date</div>
              <div class="info-value">${request.requestedDate || 'N/A'}</div>
            </div>
          </div>
          <div class="request-actions">
            <button class="action-btn approve-btn" onclick="approveRequest('${request.id}', '${request.userId}')">
              ‚úì Approve
            </button>
            <button class="action-btn reject-btn" onclick="rejectRequest('${request.id}', '${request.userId}')">
              ‚úó Reject
            </button>
          </div>
        </div>
      `).join('');
    }

    function renderApprovedTeachers() {
      const container = document.getElementById('approved-teachers-container');
      
      if (approvedTeachers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>üë®‚Äçüè´ No Approved Teachers Yet</h3>
            <p>Approved teachers will appear here once you approve their requests.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = approvedTeachers.map(teacher => `
        <div class="teacher-card">
          <div class="status-badge status-approved">Approved</div>
          <div class="request-info">
            <div class="info-item">
              <div class="info-label">Full Name</div>
              <div class="info-value">${teacher.name}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Email</div>
              <div class="info-value">${teacher.email}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Phone</div>
              <div class="info-value">${teacher.phone}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Subject/Department</div>
              <div class="info-value">${teacher.subject}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Qualification</div>
              <div class="info-value">${teacher.qualification}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Approved Date</div>
              <div class="info-value">${teacher.approvedDate || 'N/A'}</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateStatistics() {
      document.getElementById('pendingCount').textContent = pendingRequests.length;
      document.getElementById('approvedCount').textContent = approvedTeachers.length;
      document.getElementById('rejectedCount').textContent = rejectedRequests.length;
      document.getElementById('totalCount').textContent = 
        pendingRequests.length + approvedTeachers.length + rejectedRequests.length;
    }

    // Global functions for button clicks
    window.approveRequest = async (requestId, userId) => {
      try {
        showMessage('Approving teacher request...', 'success');
        
        // Update admin-requests collection
        await updateDoc(doc(db, 'admin-requests', requestId), {
          status: 'approved',
          approvedAt: new Date().toISOString(),
          approvedDate: new Date().toLocaleDateString()
        });

        // Update user's adminStatus in users collection
        await updateDoc(doc(db, 'users', userId), {
          adminStatus: 'approved'
        });

        showMessage('Teacher request approved successfully!', 'success');
        await loadAllData();
      } catch (error) {
        showMessage('Error approving request: ' + error.message, 'error');
      }
    };

    window.rejectRequest = async (requestId, userId) => {
      try {
        showMessage('Rejecting teacher request...', 'success');
        
        // Update admin-requests collection
        await updateDoc(doc(db, 'admin-requests', requestId), {
          status: 'rejected',
          rejectedAt: new Date().toISOString(),
          rejectedDate: new Date().toLocaleDateString()
        });

        // Update user's adminStatus in users collection
        await updateDoc(doc(db, 'users', userId), {
          adminStatus: 'rejected'
        });

        showMessage('Teacher request rejected successfully!', 'success');
        await loadAllData();
      } catch (error) {
        showMessage('Error rejecting request: ' + error.message, 'error');
      }
    };

    window.logout = async () => {
      try {
        await signOut(auth);
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('loggedInUserEmail');
        localStorage.removeItem('loggedInUserName');
        window.location.href = 'account.html';
      } catch (error) {
        showMessage('Error logging out: ' + error.message, 'error');
      }
    };

    function showMessage(message, type) {
      const container = document.getElementById('message-container');
      container.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>

  <script>
    VANTA.WAVES({
      el: "body",
      mouseControls: true,
      touchControls: true,
      minHeight: 200.00,
      minWidth: 200.00,
      scale: 1.00,
      scaleMobile: 1.00,
      color: 0xff6b1a,
      shininess: 50.00,
      waveHeight: 15.00,
      waveSpeed: 0.60,
      zoom: 1.20
    });
  </script>

</body>
</html>